<div class="space-y-6 max-w-6xl mx-auto pb-12">
  <!-- Top Navigation & Actions -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pb-2">
    <div class="flex items-center gap-3 sm:gap-4">
      <button
        routerLink="/vehicles-instances"
        class="bg-base-200 hover:bg-base-300 p-2 rounded-xl transition-all text-base-content/60 hover:text-primary active:scale-95"
      >
        <lucide-icon [name]="icons.ChevronLeft" class="h-6 w-6"></lucide-icon>
      </button>
      <div>
        <h1 class="text-2xl font-bold text-base-content">
          {{
            isNew()
              ? ('VEHICLE.DETAIL.TITLE_NEW' | translate)
              : ('VEHICLE.DETAIL.TITLE_EDIT' | translate)
          }}
        </h1>
        <p class="text-sm text-base-content/60">
          {{
            isNew()
              ? ('VEHICLE.DETAIL.SUBTITLE_NEW' | translate)
              : ('VEHICLE.DETAIL.SUBTITLE_EDIT' | translate)
          }}
        </p>
      </div>
    </div>
    <div class="flex items-center gap-2 sm:gap-3 w-full sm:w-auto">
      <button
        routerLink="/vehicles-instances"
        class="btn btn-ghost border-base-300 px-4 sm:px-6 font-semibold flex-1 sm:flex-none"
      >
        {{ 'VEHICLE.DETAIL.CANCEL' | translate }}
      </button>
      <button
        (click)="save()"
        class="btn btn-primary flex items-center gap-2 group px-4 sm:px-8 flex-1 sm:flex-none"
        [disabled]="!canSave()"
      >
        <lucide-icon
          [name]="icons.CircleCheckBig"
          class="h-5 w-5 group-hover:scale-110 transition-transform"
        ></lucide-icon>
        {{
          isNew()
            ? ('VEHICLE.DETAIL.CREATE' | translate)
            : ('VEHICLE.DETAIL.SAVE_CHANGES' | translate)
        }}
      </button>
    </div>
  </div>

  @if (!isNew()) {
    <!-- Profile Summary Card (Full Width, Horizontal) -->
    <div class="card bg-base-100 shadow-xl border border-base-200 rounded-2xl p-6">
      <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
        <!-- Avatar & Identity -->
        <div class="flex items-center gap-5 flex-1 min-w-0">
          <app-brand-logo
            [make]="formModel().vehicle.make"
            containerClass="w-16 h-16 rounded-2xl bg-base-200"
            fallbackClass="text-2xl"
          />
          <div class="min-w-0">
            <h2 class="text-xl font-bold text-base-content truncate">
              {{ formModel().vehicle.licensePlate }}
            </h2>
            <p class="text-base-content/60 font-medium text-sm">
              {{ formModel().vehicle.make }} {{ formModel().vehicle.model }}
              @if (formModel().vehicle.year) {
                <span class="text-base-content/40">&bull; {{ formModel().vehicle.year }}</span>
              }
            </p>
            <div class="mt-1.5">
              <span
                class="status-badge px-3 py-1 text-[10px] font-bold uppercase tracking-wider"
                [class]="getStatusBadgeClass(formModel().status)"
              >
                {{ formatStatus(formModel().status) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Key Stats -->
        <div class="flex items-center gap-3 flex-wrap shrink-0">
          <div
            class="px-4 py-2.5 bg-base-200/50 rounded-xl border border-base-200 text-center min-w-[100px]"
          >
            <p class="text-[9px] text-base-content/40 uppercase font-bold tracking-widest">
              {{ 'VEHICLE.DETAIL.JOB_NUMBER' | translate }}
            </p>
            <p class="font-mono text-sm font-bold text-primary mt-0.5 truncate">
              {{ product().code || 'N/A' }}
            </p>
          </div>
          <div
            class="px-4 py-2.5 bg-base-200/50 rounded-xl border border-base-200 text-center min-w-[100px]"
          >
            <p class="text-[9px] text-base-content/40 uppercase font-bold tracking-widest">
              {{ 'VEHICLE.DETAIL.ENTRY_DATE' | translate }}
            </p>
            <p class="text-sm font-bold text-base-content mt-0.5">
              {{ (product().vehicle?.createdAt | date: 'shortDate') || '-' }}
            </p>
          </div>
          <div
            class="px-4 py-2.5 bg-base-200/50 rounded-xl border border-base-200 text-center min-w-[100px]"
          >
            <p class="text-[9px] text-base-content/40 uppercase font-bold tracking-widest">
              {{ 'VEHICLE.DETAIL.SPECS.MILEAGE' | translate }}
            </p>
            <p class="text-sm font-bold text-base-content mt-0.5">
              {{
                formModel().vehicle.mileage ? (formModel().vehicle.mileage | number) + ' mi' : '-'
              }}
            </p>
          </div>
          <div class="px-4 py-2 bg-base-200/50 rounded-xl border border-base-200 min-w-[180px]">
            <p class="text-[9px] text-base-content/40 uppercase font-bold tracking-widest mb-1.5">
              {{ 'VEHICLES.TABLE.STATUS' | translate }}
            </p>
            <app-select
              [options]="statusSelectOptions"
              [selectedValue]="formModel().status"
              (selectionChange)="onStatusChange($event)"
              [placeholder]="'Select status'"
              [clearable]="false"
            ></app-select>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation (Full Width) -->
    <div class="bg-base-200/50 p-1.5 rounded-2xl flex w-full shadow-inner overflow-x-auto">
      <button
        (click)="setActiveTab('details')"
        class="flex-1 min-w-[120px] py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-1 sm:gap-2"
        [class]="
          activeTab() === 'details'
            ? 'bg-base-100 text-primary shadow-sm'
            : 'text-base-content/50 hover:text-base-content'
        "
      >
        <lucide-icon [name]="icons.Car" class="h-4 w-4"></lucide-icon>
        {{ 'VEHICLE.DETAIL.TABS.GENERAL' | translate }}
      </button>
      <button
        (click)="setActiveTab('operations')"
        class="flex-1 min-w-[120px] py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-1 sm:gap-2"
        [class]="
          activeTab() === 'operations'
            ? 'bg-base-100 text-primary shadow-sm'
            : 'text-base-content/50 hover:text-base-content'
        "
      >
        <lucide-icon [name]="icons.ClipboardCheck" class="h-4 w-4"></lucide-icon>
        {{ 'VEHICLE.DETAIL.TABS.OPERATIONS' | translate }}
      </button>
      <button
        (click)="setActiveTab('history')"
        class="flex-1 min-w-[120px] py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-1 sm:gap-2"
        [class]="
          activeTab() === 'history'
            ? 'bg-base-100 text-primary shadow-sm'
            : 'text-base-content/50 hover:text-base-content'
        "
      >
        <lucide-icon [name]="icons.Clock" class="h-4 w-4"></lucide-icon>
        {{ 'VEHICLE.DETAIL.TABS.HISTORY' | translate }}
      </button>
      <button
        (click)="goToInspection()"
        class="flex-1 min-w-[120px] py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all duration-300 flex items-center justify-center gap-1 sm:gap-2 text-base-content/50 hover:text-base-content"
      >
        <lucide-icon [name]="icons.ClipboardCheck" class="h-4 w-4"></lucide-icon>
        Inspection
      </button>
    </div>
  }

  <!-- Tab Content: Details (Full Width) -->
  @if (activeTab() === 'details' || isNew()) {
    <div>
      <div
        class="card bg-base-100 shadow-xl rounded-2xl border border-base-200 p-4 sm:p-8 space-y-8"
      >
        <!-- HPI & Primary Section -->
        <section>
          <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-primary/10 rounded-lg">
              <lucide-icon [name]="icons.Car" class="h-5 w-5 text-primary"></lucide-icon>
            </div>
            <h3 class="font-bold text-base-content uppercase tracking-wider text-sm">
              {{ 'VEHICLE.DETAIL.IDENTIFICATION.TITLE' | translate }}
            </h3>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
            <div class="flex gap-2 items-end lg:col-span-1">
              <div class="flex-1">
                <label
                  class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                  >{{ 'VEHICLE.DETAIL.IDENTIFICATION.PLATE' | translate }}</label
                >
                <input
                  type="text"
                  placeholder="e.g. AB12 CDE"
                  class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30 uppercase"
                  [formField]="detailForm.vehicle.licensePlate"
                  (input)="onFieldLookup('licensePlate', $any($event.target).value)"
                />
              </div>
              <button
                (click)="performHPICheck()"
                class="btn btn-secondary btn-sm h-11 px-4 rounded-lg flex items-center gap-2"
              >
                <lucide-icon [name]="icons.Search" class="h-5 w-5"></lucide-icon>
                <span class="hidden sm:inline">{{
                  'VEHICLE.DETAIL.IDENTIFICATION.HPI_CHECK' | translate
                }}</span>
              </button>
            </div>

            @if (lookupLoading()) {
              <div
                class="lg:col-span-3 p-4 rounded-2xl bg-base-200/50 border border-base-300 flex items-center gap-4"
              >
                <span class="loading loading-spinner loading-sm text-primary"></span>
                <p class="text-sm text-base-content/60 font-medium">
                  Checking for existing vehicles...
                </p>
              </div>
            }
            @if (foundVehicle() && !existingVehicleId()) {
              <div
                class="lg:col-span-3 p-4 rounded-2xl bg-warning/10 border border-warning/30 flex flex-col sm:flex-row items-start sm:items-center gap-4"
              >
                <div
                  class="w-10 h-10 rounded-full bg-warning/20 flex items-center justify-center shrink-0"
                >
                  <lucide-icon
                    [name]="icons.TriangleAlert"
                    class="h-5 w-5 text-warning"
                  ></lucide-icon>
                </div>
                <div class="flex-1">
                  <p class="font-bold text-warning text-sm">Vehicle already exists</p>
                  <p class="text-xs text-base-content/60">
                    {{ foundVehicle()!.make }} {{ foundVehicle()!.model }} —
                    {{ foundVehicle()!.licensePlate }}
                    @if (foundVehicle()!.vin) {
                      <span class="text-base-content/40">
                        &bull; VIN: {{ foundVehicle()!.vin }}</span
                      >
                    }
                  </p>
                </div>
                <div class="flex gap-2">
                  <button
                    (click)="useExistingVehicle()"
                    class="btn btn-warning btn-sm font-bold gap-1"
                  >
                    <lucide-icon [name]="icons.Check" class="h-4 w-4"></lucide-icon>
                    Use this vehicle
                  </button>
                  <button (click)="dismissDuplicate()" class="btn btn-ghost btn-sm font-bold">
                    Ignore
                  </button>
                </div>
              </div>
            }
            @if (existingVehicleId()) {
              <div
                class="lg:col-span-3 p-4 rounded-2xl bg-success/10 border border-success/30 flex items-center gap-4"
              >
                <div class="w-10 h-10 rounded-full bg-success/20 flex items-center justify-center">
                  <lucide-icon
                    [name]="icons.CircleCheckBig"
                    class="h-5 w-5 text-success"
                  ></lucide-icon>
                </div>
                <div class="flex-1">
                  <p class="font-bold text-success text-sm">Linked to existing vehicle</p>
                  <p class="text-xs text-base-content/60">
                    A new vehicle instance will be created and linked to the existing record.
                  </p>
                </div>
              </div>
            }
            @if (hpiResult() && !existingVehicleId()) {
              <div
                class="lg:col-span-3 p-4 rounded-2xl bg-success/10 border border-success/30 flex items-center gap-4"
              >
                <div class="w-10 h-10 rounded-full bg-success/20 flex items-center justify-center">
                  <lucide-icon
                    [name]="icons.CircleCheckBig"
                    class="h-5 w-5 text-success"
                  ></lucide-icon>
                </div>
                <div class="flex-1">
                  <p class="font-bold text-success text-sm italic">
                    {{ 'VEHICLE.DETAIL.IDENTIFICATION.HPI_FOUND' | translate }}
                  </p>
                  <p class="text-xs text-base-content/60">
                    {{ 'VEHICLE.DETAIL.IDENTIFICATION.HPI_NOTE' | translate }}
                  </p>
                </div>
              </div>
            }
            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.IDENTIFICATION.MAKE' | translate }}</label
              >
              <input
                type="text"
                placeholder="e.g. BMW"
                class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30"
                [formField]="detailForm.vehicle.make"
              />
            </div>

            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.IDENTIFICATION.MODEL' | translate }}</label
              >
              <input
                type="text"
                placeholder="e.g. 320d M Sport"
                class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30"
                [formField]="detailForm.vehicle.model"
              />
            </div>
          </div>
        </section>

        <div class="divider"></div>

        <!-- Technical Specs -->
        <section>
          <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-secondary/10 rounded-lg">
              <lucide-icon [name]="icons.Settings" class="h-5 w-5 text-secondary"></lucide-icon>
            </div>
            <h3 class="font-bold text-base-content uppercase tracking-wider text-sm">
              {{ 'VEHICLE.DETAIL.SPECS.TITLE' | translate }}
            </h3>
          </div>

          <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.SPECS.YEAR' | translate }}</label
              >
              <input
                type="number"
                class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30"
                [formField]="detailForm.vehicle.year"
              />
            </div>
            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.SPECS.COLOUR' | translate }}</label
              >
              <input
                type="text"
                placeholder="e.g. Black"
                class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30"
                [formField]="detailForm.vehicle.colour"
              />
            </div>
            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.SPECS.MILEAGE' | translate }}</label
              >
              <div class="relative">
                <input
                  type="number"
                  class="input input-bordered w-full h-11 pr-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30"
                  [formField]="detailForm.vehicle.mileage"
                />
                <span
                  class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold text-base-content/40"
                  >MI</span
                >
              </div>
            </div>
            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.SPECS.ENGINE' | translate }}</label
              >
              <input
                type="text"
                placeholder="e.g. 2.0L"
                class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30"
                [formField]="detailForm.vehicle.engine"
              />
            </div>
            <div class="lg:col-span-2 space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.SPECS.VIN' | translate }}</label
              >
              <input
                type="text"
                placeholder="Vehicle Identification Number"
                class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30 font-mono"
                [formField]="detailForm.vehicle.vin"
                (input)="onFieldLookup('vin', $any($event.target).value)"
              />
            </div>
            <div class="lg:col-span-2 space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.SPECS.NEXT_MOT' | translate }}</label
              >
              <input
                type="date"
                class="input input-bordered w-full h-11 rounded-xl border-base-300 bg-base-100 focus:outline-none focus:ring-2 focus:ring-primary/30"
                [formField]="detailForm.vehicle.nextEntryDate"
              />
            </div>
          </div>
        </section>

        <div class="divider"></div>

        <!-- Assignment -->
        <section>
          <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-info/10 rounded-lg">
              <lucide-icon [name]="icons.Users" class="h-5 w-5 text-info"></lucide-icon>
            </div>
            <h3 class="font-bold text-base-content uppercase tracking-wider text-sm">
              {{ 'VEHICLE.DETAIL.ASSIGNMENT.TITLE' | translate }}
            </h3>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl">
            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
                >{{ 'VEHICLE.DETAIL.ASSIGNMENT.ASSIGN_CLIENT' | translate }}</label
              >
              <app-select
                [options]="clientSelectOptions()"
                [selectedValue]="formModel().customerId"
                (selectionChange)="onCustomerChange($event)"
                [placeholder]="'VEHICLE.DETAIL.ASSIGNMENT.SELECT_CLIENT' | translate"
              ></app-select>
            </div>

            <div class="space-y-2">
              <label
                class="block text-xs font-bold text-base-content/40 uppercase tracking-widest mb-2 pl-1"
              >
                Inspection template
              </label>
              <app-select
                [options]="inspectionTemplateSelectOptions()"
                [selectedValue]="product().inspectionTemplateId"
                (selectionChange)="onInspectionTemplateChange($event)"
                [placeholder]="'No template'"
              ></app-select>
            </div>
          </div>
        </section>
      </div>
    </div>
  }

  <!-- Tab Content: Operations (Full Width) -->
  @if (activeTab() === 'operations') {
    <div>
      <div class="card bg-base-100 shadow-xl rounded-2xl border border-base-200 p-4 sm:p-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-7">
          <div>
            <h3 class="font-bold text-xl text-base-content">
              {{ 'VEHICLE.DETAIL.OPERATIONS.TITLE' | translate }}
            </h3>
            <p class="text-sm text-base-content/60">
              {{ 'VEHICLE.DETAIL.OPERATIONS.SUBTITLE' | translate }}
            </p>
          </div>
          <div class="rounded-xl border border-base-200 bg-base-100 px-4 py-2">
            <p class="text-xs font-semibold text-base-content/60">
              {{ getOperationsStats(product()._id!).completed }} /
              {{ getOperationsStats(product()._id!).total }}
              completed
            </p>
            <progress
              class="progress progress-primary h-2 w-40"
              [value]="getOperationsStats(product()._id!).progress"
              max="100"
            ></progress>
          </div>
        </div>

        <!-- Add Operation Selector -->
        <div
          class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 mb-6 p-4 bg-base-200/30 rounded-xl border border-base-200/50"
        >
          <app-select
            [options]="masterOperationSelectOptions()"
            [selectedValue]="selectedOperationId()"
            (selectionChange)="selectedOperationId.set($event || '')"
            [placeholder]="'Select an operation to add...'"
            class="flex-1"
          ></app-select>
          <button
            (click)="addOperationFromMaster()"
            class="btn btn-primary btn-sm gap-2 font-bold"
            [disabled]="!selectedOperationId()"
          >
            <lucide-icon [name]="icons.Plus" class="h-4 w-4"></lucide-icon>
            Add
          </button>
        </div>

        <div class="space-y-3.5">
          @for (
            op of getVehicleOperations(product().vehicleId || product()._id || '');
            track op.id
          ) {
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-5 bg-gradient-to-r from-base-100 to-base-200/60 border border-base-200 rounded-2xl hover:shadow-md hover:border-primary/20 transition-all group"
            >
              <div class="flex items-center gap-4 min-w-0">
                <div
                  class="w-12 h-12 rounded-xl bg-base-100 border border-base-300 shadow-sm flex items-center justify-center text-primary font-bold"
                >
                  {{ op.operation?.code }}
                </div>
                <div class="min-w-0">
                  <p
                    class="font-bold text-base-content group-hover:text-primary transition-colors truncate"
                  >
                    {{ op.operation?.name }}
                  </p>
                  <div class="flex items-center gap-2 mt-1">
                    <input
                      type="number"
                      class="input input-xs input-bordered w-[72px]"
                      title="Duration (min)"
                      [ngModel]="op.actualDuration ?? op.operation?.estimatedDuration"
                      (change)="updateOperationField(op, 'duration', $event)"
                    />
                    <span class="text-xs text-base-content/50 font-medium">min</span>
                    <span class="text-base-content/30 text-xs">&bull;</span>
                    <span class="text-xs text-base-content/50 font-medium tracking-tighter">£</span>
                    <input
                      type="number"
                      class="input input-xs input-bordered w-[72px]"
                      title="Rate (/hr)"
                      [ngModel]="op.hourlyRate ?? op.operation?.defaultPrice"
                      (change)="updateOperationField(op, 'rate', $event)"
                    />
                  </div>
                </div>
              </div>
              <div class="flex items-center justify-between sm:justify-end gap-3">
                <app-select
                  [options]="operationStatusSelectOptions"
                  [selectedValue]="op.status"
                  (selectionChange)="updateOperationStatus(op, $event)"
                  [disabled]="isOperationSaving(op.id)"
                  [clearable]="false"
                  [placeholder]="'Select status'"
                ></app-select>
                @if (isOperationSaving(op.id)) {
                  <span class="loading loading-spinner loading-sm text-primary"></span>
                } @else {
                  <span
                    class="status-badge px-3.5 py-1.5 text-[10px] font-bold uppercase tracking-wider"
                    [class]="getOperationStatusClass(op.status)"
                  >
                    {{ formatStatus(op.status) }}
                  </span>
                }
                <button
                  (click)="removeOperation(op)"
                  class="btn btn-ghost btn-sm btn-square text-error/60 hover:text-error hover:bg-error/10"
                  title="Remove operation"
                >
                  <lucide-icon [name]="icons.Trash2" class="h-4 w-4"></lucide-icon>
                </button>
              </div>
            </div>
          } @empty {
            <div
              class="text-center py-16 bg-base-200/20 rounded-3xl border-2 border-dashed border-base-200"
            >
              <div
                class="w-16 h-16 bg-base-200 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <lucide-icon
                  [name]="icons.ClipboardList"
                  class="h-8 w-8 text-base-content/20"
                ></lucide-icon>
              </div>
              <p class="text-base-content/60 font-medium">
                {{ 'VEHICLE.DETAIL.OPERATIONS.EMPTY.TITLE' | translate }}
              </p>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Tab Content: History (Full Width) -->
  @if (activeTab() === 'history') {
    <div>
      <div class="card bg-base-100 shadow-xl rounded-2xl border border-base-200 p-4 sm:p-8">
        @if (activityLoading()) {
          <div class="text-center py-16">
            <span class="loading loading-spinner loading-lg text-primary"></span>
          </div>
        } @else if (activityTimeline().length === 0) {
          <div class="text-center py-16 sm:py-20">
            <div
              class="w-20 h-20 bg-base-200 rounded-full flex items-center justify-center mx-auto mb-6"
            >
              <lucide-icon
                [name]="icons.Clock"
                class="h-10 w-10 text-base-content/20"
              ></lucide-icon>
            </div>
            <h3 class="font-bold text-xl text-base-content mb-2">
              {{ 'VEHICLE.DETAIL.HISTORY.TITLE' | translate }}
            </h3>
            <p class="text-base-content/60 max-w-xs mx-auto">
              {{ 'VEHICLE.DETAIL.HISTORY.DESC' | translate }}
            </p>
          </div>
        } @else {
          <div class="relative">
            <div class="hidden md:block absolute left-1/2 top-0 bottom-0 w-px bg-base-300/80"></div>
            <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-y-6 md:gap-y-5 md:gap-x-6">
              @for (
                event of activityTimeline();
                track event.occurredAt.toISOString() + event.message;
                let i = $index
              ) {
                <article
                  class="rounded-2xl border border-base-200 bg-base-100 p-4 shadow-sm hover:shadow-md transition-shadow"
                  [class]="getTimelineCardClass(i)"
                >
                  <p class="text-base font-bold text-base-content leading-tight">
                    {{ event.message }}
                  </p>
                  <p class="mt-1 text-sm text-base-content/60">
                    {{ event.occurredAt | date: 'dd/MM/yy HH:mm' }}
                  </p>
                  <div class="mt-2 flex items-center gap-2 text-xs text-base-content/50">
                    <lucide-icon [name]="icons.User" class="h-4 w-4"></lucide-icon>
                    <span>{{ event.actorName || 'system' }}</span>
                  </div>
                </article>
                <div class="hidden md:flex items-center justify-center md:col-start-2">
                  <span
                    class="h-3.5 w-3.5 rounded-full bg-primary border-2 border-base-100 shadow"
                  ></span>
                </div>
                <div
                  class="hidden md:block"
                  [class]="i % 2 === 0 ? 'md:col-start-3' : 'md:col-start-1'"
                ></div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
