<div class="space-y-6">
<div class="card bg-base-100 shadow-xl border border-base-200 overflow-hidden">
  <div class="card-body p-6 gap-0">
    <!-- Summary stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-base-200/30 rounded-xl p-4 border border-base-200">
        <div class="text-xs font-bold uppercase tracking-wider text-base-content/60 mb-1">
          {{ 'INVOICING.PENDING' | translate }}
        </div>
        <div class="text-3xl font-black text-warning">{{ pendingCount() }}</div>
      </div>
      <div class="bg-base-200/30 rounded-xl p-4 border border-base-200">
        <div class="text-xs font-bold uppercase tracking-wider text-base-content/60 mb-1">
          {{ 'INVOICING.READY' | translate }}
        </div>
        <div class="text-3xl font-black text-info">{{ readyToInvoiceCount() }}</div>
      </div>
      <div class="bg-base-200/30 rounded-xl p-4 border border-base-200">
        <div class="text-xs font-bold uppercase tracking-wider text-base-content/60 mb-1">
          {{ 'INVOICING.INVOICED' | translate }}
        </div>
        <div class="text-3xl font-black text-success">{{ invoicedTodayCount() }}</div>
      </div>
      <div class="bg-base-200/30 rounded-xl p-4 border border-base-200">
        <div class="text-xs font-bold uppercase tracking-wider text-base-content/60 mb-1">
          {{ 'INVOICING.REVENUE_TODAY' | translate }}
        </div>
        <div class="text-3xl font-black text-primary">
          £{{ totalRevenueToday().toLocaleString() }}
        </div>
      </div>
    </div>

    <!-- Tabs + Grid section -->
    <div class="border-t border-base-200 pt-6 -mx-2">
      <div class="tabs tabs-boxed bg-base-200/50 p-1 rounded-xl w-fit mb-4">
        <button
          class="tab rounded-lg px-4"
          [class.tab-active]="activeTab() === 'pending'"
          (click)="setTab('pending')"
        >
          {{ 'INVOICING.PENDING' | translate }}
        </button>
        <button
          class="tab rounded-lg px-4"
          [class.tab-active]="activeTab() === 'completed'"
          (click)="setTab('completed')"
        >
          {{ 'INVOICING.COMPLETED' | translate }}
        </button>
        <button
          class="tab rounded-lg px-4"
          [class.tab-active]="activeTab() === 'invoiced'"
          (click)="setTab('invoiced')"
        >
          {{ 'INVOICING.INVOICED' | translate }}
        </button>
      </div>

      <app-data-grid
        [config]="gridConfig"
        (stateChange)="handleGridStateChange($event)"
        (selectionChange)="handleSelectionChanged($event)"
      />
    </div>
  </div>
</div>

@if (selectedRows().length > 0) {
    <div class="sticky bottom-4 z-20">
      <div
        class="flex items-center justify-between p-4 bg-base-100 rounded-xl shadow-lg border border-primary/20 ring-1 ring-primary/5"
      >
        <div class="flex items-center gap-3">
          <div class="badge badge-primary badge-lg">{{ selectedRows().length }}</div>
          <span class="font-medium">{{ 'COMMON.OPERATIONS_SELECTED' | translate }}</span>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-sm btn-ghost" (click)="clearSelection()">{{ 'COMMON.CANCEL' | translate }}</button>
          <button
            class="btn btn-sm btn-outline btn-neutral"
            onclick="document.getElementById('invoice_preview_modal').showModal()"
          >
            {{ 'COMMON.PREVIEW' | translate }}
          </button>
          <button class="btn btn-sm btn-primary" (click)="invoiceSelection()">
            {{ 'COMMON.GENERATE_INVOICE' | translate }}
          </button>
        </div>
      </div>
    </div>
}

<dialog id="invoice_preview_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box w-11/12 max-w-3xl bg-base-100 p-0 overflow-hidden shadow-2xl rounded-2xl">
      @if (invoicePreviewData(); as preview) {
        <div class="p-8 sm:p-12 bg-white text-black min-h-[600px] relative">
          <div class="flex justify-between items-start border-b-2 border-slate-100 pb-8 mb-8">
            <div>
              <h2 class="text-3xl font-black text-slate-800 tracking-tight">INVOICE</h2>
              <p class="text-slate-500 mt-1 font-medium">{{ preview.invoiceNumber }}</p>
            </div>
            <div class="text-right">
              <div class="font-bold text-xl text-primary">ArrowAuto</div>
              <p class="text-sm text-slate-500 mt-1">
                123 Mechanics Way<br />London, UK AB1 2CD<br />contact&#64;arrowauto.co.uk
              </p>
            </div>
          </div>

          <div class="flex justify-between items-end mb-10">
            <div>
              <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Bill To</p>
              <p class="font-bold text-slate-800 text-lg">
                {{ preview.groups[0]?.client || 'Walk-in Client' }}
              </p>
            </div>
            <div class="text-right">
              <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Date</p>
              <p class="font-semibold text-slate-800">{{ preview.date | date: 'longDate' }}</p>
            </div>
          </div>

          <div class="space-y-8">
            @for (group of preview.groups; track $index) {
              <div>
                <div
                  class="bg-slate-50 py-3 px-4 rounded-xl mb-4 border border-slate-100 flex justify-between items-center"
                >
                  <div>
                    <p class="font-bold text-slate-800">
                      {{ group.vehicle.licensePlate || 'Unknown Plate' }}
                    </p>
                    <p class="text-xs text-slate-500 font-medium">
                      {{ group.vehicle.make }} {{ group.vehicle.model }}
                    </p>
                  </div>
                  <div class="text-right">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">
                      Subtotal
                    </p>
                    <p class="font-bold text-slate-800">£{{ group.vehicleTotal.toFixed(2) }}</p>
                  </div>
                </div>
              </div>
            }
          </div>

          <div class="mt-12 border-t border-slate-200 pt-8 flex justify-end">
            <div class="w-64 space-y-3">
              <div class="flex justify-between text-sm text-slate-500 font-medium">
                <span>Subtotal</span>
                <span>£{{ preview.subtotal.toFixed(2) }}</span>
              </div>
              <div class="flex justify-between text-sm text-slate-500 font-medium">
                <span>VAT (21%)</span>
                <span>£{{ preview.tax.toFixed(2) }}</span>
              </div>
              <div class="flex justify-between items-end pt-4 border-t border-slate-200">
                <span class="text-sm font-bold text-slate-800 uppercase tracking-widest"
                  >Total Due</span
                >
                <span class="text-2xl font-black text-primary"
                  >£{{ preview.grandTotal.toFixed(2) }}</span
                >
              </div>
            </div>
          </div>
        </div>
      }

      <div class="bg-base-200/50 p-4 border-t border-base-300 flex justify-end gap-3">
        <form method="dialog">
          <button class="btn btn-ghost hover:bg-base-300">Close</button>
        </form>
        <button class="btn btn-primary" onclick="window.print()">Print Invoice</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop bg-neutral/80 backdrop-blur-sm">
      <button>close</button>
    </form>
  </dialog>

  <dialog id="complete_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box bg-base-100/95 backdrop-blur-sm shadow-2xl border border-base-300">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">x</button>
      </form>
      <h3 class="font-bold text-xl mb-6">Complete Operation</h3>

      @if (selectedItem()) {
        <div class="space-y-6">
          <div class="alert bg-base-200/50 border border-base-200 shadow-sm rounded-xl">
            <div>
              <p class="font-bold text-lg text-primary">{{ selectedItem()!.operation }}</p>
              <div class="flex items-center gap-2 text-sm opacity-70 mt-1">
                <span class="font-mono bg-base-300 px-1 rounded text-xs">{{
                  selectedItem()!.job
                }}</span>
                <span>•</span>
                <span class="font-semibold">{{ selectedItem()!.plate }}</span>
              </div>
            </div>
          </div>

          <div class="form-control">
            <label class="label"
              ><span class="label-text font-medium text-xs uppercase tracking-wide opacity-70"
                >Assigned Operator</span
              ></label
            >
            <app-select
              [options]="operatorSelectOptions()"
              [selectedValue]="completeForm.operatorId"
              (selectionChange)="completeForm.operatorId = $event || ''"
              [placeholder]="'Select operator...'"
            ></app-select>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label"
                ><span class="label-text font-medium text-xs uppercase tracking-wide opacity-70"
                  >Actual Duration (min)</span
                ></label
              >
              <input
                type="number"
                class="input input-bordered w-full h-11"
                [(ngModel)]="completeForm.duration"
              />
            </div>
            <div class="form-control">
              <label class="label"
                ><span class="label-text font-medium text-xs uppercase tracking-wide opacity-70"
                  >Hourly Rate (£)</span
                ></label
              >
              <input
                type="number"
                class="input input-bordered w-full h-11"
                [(ngModel)]="completeForm.hourlyRate"
              />
            </div>
          </div>

          <div class="form-control">
            <label class="label"
              ><span class="label-text font-medium text-xs uppercase tracking-wide opacity-70"
                >Technician Notes</span
              ></label
            >
            <textarea
              class="textarea textarea-bordered h-24"
              [(ngModel)]="completeForm.notes"
            ></textarea>
          </div>

          <div class="bg-base-100 p-4 rounded-xl border border-base-200/80 mt-2">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium opacity-60 uppercase tracking-wide"
                >Calculated Total</span
              >
              <span class="text-2xl font-black text-primary"
                >£{{ calculateCompleteTotal().toFixed(2) }}</span
              >
            </div>
          </div>
        </div>
      }

      <div class="modal-action mt-8">
        <form method="dialog">
          <button class="btn btn-ghost hover:bg-base-200">Cancel</button>
        </form>
        <button class="btn btn-success px-6 text-white" (click)="completeOperation()">
          Mark Complete
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop bg-neutral/50 backdrop-blur-sm">
      <button>close</button>
    </form>
  </dialog>
</div>
